{% extends "base.html" %}
{% block title %}Parts List - BOM Inventory{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-list"></i> Parts List
        </h1>
    </div>
</div>

<!-- Search and Filter Form -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="search_term" class="form-label">Search Parts</label>
                <input type="text" class="form-control" id="search_term" name="search_term"
                       value="{{ search_term }}" placeholder="Part number, name, or description">
            </div>
            
            <div class="col-md-2">
                {{ form.supplier_filter.label(class="form-label") }}
                {{ form.supplier_filter(class="form-select") }}
            </div>
            
            <div class="col-md-2">
                {{ form.component_filter.label(class="form-label") }}
                {{ form.component_filter(class="form-select") }}
            </div>
            
            <div class="col-md-2">
                {{ form.low_stock_only.label(class="form-label") }}
                {{ form.low_stock_only(class="form-select") }}
            </div>
            
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid gap-2 d-md-flex">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Search
                    </button>
                    <a href="{{ url_for('main.parts_list') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> Clear
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Results Summary -->
{% if parts.items %}
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> 
    Showing {{ parts.items|length }} of {{ parts.total }} parts
    {% if search_term or supplier_filter or component_filter or low_stock_only %}
        (filtered)
    {% endif %}
</div>
{% endif %}

<!-- Parts Table with Proper Borders -->
<div class="card">
    <div class="card-body p-0">
        {% if parts.items %}
        <div class="table-responsive">
            <table class="table table-bordered table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th class="border border-secondary px-3 py-3 text-center">Part Number</th>
                        <th class="border border-secondary px-3 py-3 text-center">Description</th>
                        <th class="border border-secondary px-3 py-3 text-center">Supplier</th>
                        <th class="border border-secondary px-3 py-3 text-center">Component</th>
                        <th class="border border-secondary px-3 py-3 text-center">Type</th>
                        <th class="border border-secondary px-3 py-3 text-center">Qty/LRV</th>
                        <th class="border border-secondary px-3 py-3 text-center">On Site</th>
                        <th class="border border-secondary px-3 py-3 text-center">Current Stock</th>
                        <th class="border border-secondary px-3 py-3 text-center">LRV Coverage</th>
                        <th class="border border-secondary px-3 py-3 text-center">Status</th>
                        <th class="border border-secondary px-3 py-3 text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for part in parts.items %}
                    <tr class="{% if part.qty_current_stock <= 0 %}table-danger{% elif part.lrv_coverage < 10 %}table-warning{% endif %}">
                        <td class="border border-secondary px-3 py-2 text-center align-middle">
                            <strong class="text-primary">{{ part.part_number }}</strong>
                        </td>
                        <td class="border border-secondary px-3 py-2 align-middle">
                            <div class="fw-medium">{{ part.part_name or '-' }}</div>
                            {% if part.notes %}
                            <small class="text-muted">{{ part.notes[:40] }}{% if part.notes|length > 40 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td class="border border-secondary px-3 py-2 text-center align-middle">
                            <span class="badge bg-light text-dark">{{ part.supplier or '-' }}</span>
                        </td>
                        <td class="border border-secondary px-3 py-2 align-middle">
                            <small class="text-muted">{{ part.component[:30] if part.component else '-' }}{% if part.component and part.component|length > 30 %}...{% endif %}</small>
                        </td>
                        <td class="border border-secondary px-3 py-2 text-center align-middle">
                            {% if part.consumable_or_essential == 'Long Lead' %}
                                <span class="badge bg-warning text-dark">Long Lead</span>
                            {% elif part.consumable_or_essential == 'Consumables' %}
                                <span class="badge bg-info">Consumables</span>
                            {% elif part.consumable_or_essential == 'Quick Delivery' %}
                                <span class="badge bg-success">Quick Delivery</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ part.consumable_or_essential or 'Essential' }}</span>
                            {% endif %}
                        </td>
                        <td class="border border-secondary px-3 py-2 text-center align-middle">
                            <span class="fw-medium">{{ part.qty_per_lrv or 0 }}</span>
                        </td>
                        <td class="border border-secondary px-3 py-2 text-center align-middle">
                            <span class="text-info fw-medium">{{ part.qty_on_site or 0 }}</span>
                        </td>
                        <td class="border border-secondary px-3 py-2 text-center align-middle">
                            <span class="fw-bold fs-5 {% if part.qty_current_stock <= 0 %}text-danger{% elif part.qty_current_stock < 10 %}text-warning{% else %}text-success{% endif %}">
                                {{ part.qty_current_stock or 0 }}
                            </span>
                        </td>
                        <td class="border border-secondary px-3 py-2 text-center align-middle">
                            <span class="fw-medium {% if part.lrv_coverage < 5 %}text-danger{% elif part.lrv_coverage < 10 %}text-warning{% else %}text-success{% endif %}">
                                {{ "%.1f"|format(part.lrv_coverage or 0) }}
                            </span>
                        </td>
                        <td class="border border-secondary px-3 py-2 text-center align-middle">
                            {% if part.qty_current_stock <= 0 %}
                                <span class="badge bg-danger">Out of Stock</span>
                            {% elif part.lrv_coverage < 5 %}
                                <span class="badge bg-danger">Critical</span>
                            {% elif part.lrv_coverage < 10 %}
                                <span class="badge bg-warning">Low</span>
                            {% else %}
                                <span class="badge bg-success">OK</span>
                            {% endif %}
                        </td>
                        <td class="border border-secondary px-2 py-2 text-center align-middle">
                            <div class="d-flex flex-column gap-1">
                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                        data-bs-toggle="modal" data-bs-target="#partModal{{ loop.index }}" 
                                        title="View Details">
                                    <i class="fas fa-eye"></i> View
                                </button>
                                <a href="{{ url_for('main.delivery_log') }}?part_number={{ part.part_number }}"
                                   class="btn btn-outline-success btn-sm" title="Add Delivery">
                                    <i class="fas fa-plus"></i> Add
                                </a>
                                <a href="{{ url_for('main.stock_adjustment') }}?part_number={{ part.part_number }}"
                                   class="btn btn-outline-warning btn-sm" title="Adjust Stock">
                                    <i class="fas fa-edit"></i> Adjust
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- All Modals Outside the Table -->
        {% for part in parts.items %}
        <div class="modal fade" id="partModal{{ loop.index }}" tabindex="-1" aria-labelledby="partModalLabel{{ loop.index }}" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="partModalLabel{{ loop.index }}">
                            <i class="fas fa-box"></i> {{ part.part_number }} - {{ part.part_name }}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle text-primary"></i> Basic Information</h6>
                                <table class="table table-bordered table-sm">
                                    <tr><td class="fw-bold bg-light">Part Number:</td><td>{{ part.part_number }}</td></tr>
                                    <tr><td class="fw-bold bg-light">Description:</td><td>{{ part.part_name or '-' }}</td></tr>
                                    <tr><td class="fw-bold bg-light">Supplier:</td><td>{{ part.supplier or '-' }}</td></tr>
                                    <tr><td class="fw-bold bg-light">Component:</td><td>{{ part.component or '-' }}</td></tr>
                                    <tr><td class="fw-bold bg-light">Type:</td><td>{{ part.consumable_or_essential or '-' }}</td></tr>
                                    <tr><td class="fw-bold bg-light">Order Status:</td><td>{{ part.order_status or '-' }}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-warehouse text-success"></i> Stock Information</h6>
                                <table class="table table-bordered table-sm">
                                    <tr><td class="fw-bold bg-light">Qty per LRV:</td><td>{{ part.qty_per_lrv or 0 }}</td></tr>
                                    <tr><td class="fw-bold bg-light">Total for 233 LRV:</td><td>{{ part.total_needed_233_lrv or 0 }}</td></tr>
                                    <tr><td class="fw-bold bg-light">Total Received:</td><td>{{ part.qty_on_site or 0 }}</td></tr>
                                    <tr><td class="fw-bold bg-light">Shipped Out:</td><td>{{ part.qty_shipped_out or 0 }}</td></tr>
                                    <tr><td class="fw-bold bg-light">Current Stock:</td><td class="fw-bold {% if part.qty_current_stock <= 0 %}text-danger{% else %}text-success{% endif %}">{{ part.qty_current_stock or 0 }}</td></tr>
                                    <tr><td class="fw-bold bg-light">LRV Coverage:</td><td>{{ "%.1f"|format(part.lrv_coverage or 0) }} trains</td></tr>
                                    <tr><td class="fw-bold bg-light">Back Ordered:</td><td>{{ part.back_order_qty or 0 }}</td></tr>
                                </table>
                            </div>
                        </div>
                        {% if part.notes %}
                        <div class="mt-3">
                            <h6><i class="fas fa-sticky-note text-warning"></i> Notes</h6>
                            <div class="alert alert-light border">{{ part.notes }}</div>
                        </div>
                        {% endif %}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> Close
                        </button>
                        <a href="{{ url_for('main.delivery_log') }}?part_number={{ part.part_number }}"
                           class="btn btn-success">
                            <i class="fas fa-truck"></i> Add Delivery
                        </a>
                        <a href="{{ url_for('main.stock_adjustment') }}?part_number={{ part.part_number }}"
                           class="btn btn-warning">
                            <i class="fas fa-edit"></i> Adjust Stock
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        <!-- Pagination -->
        {% if parts.pages > 1 %}
        <div class="px-3 py-3 border-top">
            <nav aria-label="Parts pagination">
                <ul class="pagination justify-content-center mb-0">
                    {% if parts.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('main.parts_list', page=parts.prev_num,
                           search_term=search_term, supplier_filter=supplier_filter, 
                           component_filter=component_filter, low_stock_only=low_stock_only) }}">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in parts.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != parts.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('main.parts_list', page=page_num,
                                   search_term=search_term, supplier_filter=supplier_filter,
                                   component_filter=component_filter, low_stock_only=low_stock_only) }}">{{ page_num }}</a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if parts.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('main.parts_list', page=parts.next_num,
                           search_term=search_term, supplier_filter=supplier_filter,
                           component_filter=component_filter, low_stock_only=low_stock_only) }}">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No parts found</h5>
            <p class="text-muted">Try adjusting your search criteria or <a href="{{ url_for('main.parts_list') }}" class="text-decoration-none">clear filters</a>.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Stats Card -->
{% if parts.items %}
<div class="row mt-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white border">
            <div class="card-body text-center">
                <h5 class="card-title">Total Parts</h5>
                <h2>{{ parts.total }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white border">
            <div class="card-body text-center">
                <h5 class="card-title">In Stock</h5>
                <h2>{{ parts.items|selectattr("qty_current_stock", "gt", 0)|list|length }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white border">
            <div class="card-body text-center">
                <h5 class="card-title">Low Stock</h5>
                <h2>{{ parts.items|selectattr("lrv_coverage", "lt", 10)|selectattr("qty_current_stock", "gt", 0)|list|length }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white border">
            <div class="card-body text-center">
                <h5 class="card-title">Out of Stock</h5>
                <h2>{{ parts.items|selectattr("qty_current_stock", "eq", 0)|list|length }}</h2>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-populate part number in forms when coming from parts list
    const urlParams = new URLSearchParams(window.location.search);
    const partNumber = urlParams.get('part_number');
    if (partNumber) {
        const partNumberInput = document.querySelector('input[name="part_number"]');
        if (partNumberInput) {
            partNumberInput.value = partNumber;
        }
    }
    
    // Ensure all modals are hidden on page load
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        modal.style.display = 'none';
        modal.classList.remove('show');
        modal.setAttribute('aria-hidden', 'true');
    });
    
    // Remove any existing modal backdrops
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => backdrop.remove());
    
    // Remove modal-open class from body
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
    
    // Add hover effects to table rows
    const tableRows = document.querySelectorAll('tbody tr');
    tableRows.forEach(row => {
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'scale(1.002)';
            this.style.transition = 'transform 0.2s ease';
            this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
        });
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'scale(1)';
            this.style.boxShadow = 'none';
        });
    });
});
</script>
{% endblock %}